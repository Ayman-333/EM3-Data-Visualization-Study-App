<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <title>Condegram Spiral Plot</title>
    <style type="text/css" media="screen">
      body {
        font-family: 'Arial', 'Lucida Sans Unicode', 'Geneva', 'Verdana',
          sans-serif;
        text-align: center;
        margin: 0;
        padding: 0;
      }
      p {
        padding: 0;
        margin: 0;
        font-size: 180%;
      }
      .axis path {
        fill: none;
        stroke: #999;
        stroke-dasharray: 2 3;
      }
      .axis text {
        font-size: 13px;
        stroke: #000;
      }
      text.title {
        font-size: 24px;
      }
      circle.tick {
        fill: #f3f3f3;
        stroke: #999;
        stroke-dasharray: 2 3;
      }
      path.spiral {
        fill: none;
        stroke: #ee8d18;
        stroke-width: 3px;
      }

      .tooltip {
        background: #eee;
        box-shadow: 0 0 5px #999999;
        color: #333;
        font-size: 13px;
        left: 130px;
        padding: 10px;
        position: absolute;
        text-align: center;
        top: 95px;
        z-index: 10;
        display: block;
        opacity: 0;
      }
    </style>
    <script
      data-require="d3@4.0.0"
      data-semver="4.0.0"
      src="https://d3js.org/d3.v4.js"
    ></script>
    <p>Touch bars for consumption information</p>
  </head>
  <body>
    <div id="chart"></div>
    <script type="text/javascript">
      var width = window.innerWidth,
        height = window.innerHeight,
        start = 0,
        end = 2.25,
        numSpirals = 3,
        margin = { top: 0, bottom: 0, left: 0, right: 0 },
        padding = { top: 0, bottom: 0, left: 0, right: 0 };

      var theta = function(r) {
        return numSpirals * Math.PI * r;
      };

      var r = d3.min([width, height]) / 2;

      var radius = d3
        .scaleLinear()
        .domain([start, end])
        .range([40, r]);

      var svg = d3
        .select('#chart')
        .append('svg')
        .attr('width', width - 50)
        .attr('height', height)
        // .attr("cx", 25)
        .attr('cy', 100)
        .append('g')
        .attr(
          'transform',
          'translate(' + width / 2.3 + ',' + height / 1.86 + ')',
        );
      // To change the position of the spiral, control the denominator of the width and height.
      // .attr("width", width - 100)
      // .attr("height", height);

      var points = d3.range(start, end + 0.001, (end - start) / 1000);

      var spiral = d3
        .radialLine()
        .curve(d3.curveCardinal)
        .angle(theta)
        .radius(radius);

      var path = svg
        .append('path')
        .datum(points)
        .attr('id', 'spiral')
        .attr('d', spiral)
        .style('fill', 'none')
        .style('stroke', 'steelblue');

      var data2007 = {
        '1/1/2007': 6.232,
        '1/2/2007': 6.91,
        '1/3/2007': 5.109,
        '1/4/2007': 19.544,
        '1/5/2007': 9.464,
        '1/6/2007': 7.416,
        '1/7/2007': 22.974,
        '1/8/2007': 18.014,
        '1/9/2007': 15.745,
        '1/10/2007': 16.239,
        '1/11/2007': 15.963,
        '1/12/2007': 8.715,
        '1/13/2007': 22.122,
        '1/14/2007': 18.967,
        '1/15/2007': 18.501,
        '1/16/2007': 9.29,
        '1/17/2007': 25.301,
        '1/18/2007': 13.827,
        '1/19/2007': 9.605,
        '1/20/2007': 20.986,
        '1/21/2007': 27.512,
        '1/22/2007': 15.398,
        '1/23/2007': 6.125,
        '1/24/2007': 17.688,
        '1/25/2007': 12.659,
        '1/26/2007': 9.662,
        '1/27/2007': 17.44,
        '1/28/2007': 19.508,
        '1/29/2007': 16.671,
        '1/30/2007': 10.696,
        '1/31/2007': 21.002,
        '2/1/2007': 14.701,
        '2/2/2007': 11.694,
        '2/3/2007': 27.153,
        '2/4/2007': 22.46,
        '2/5/2007': 11.309,
        '2/6/2007': 6.107,
        '2/7/2007': 18.798,
        '2/8/2007': 12.749,
        '2/9/2007': 12.815,
        '2/10/2007': 22.307,
        '2/11/2007': 20.309,
        '2/12/2007': 14.143,
        '2/13/2007': 9.084,
        '2/14/2007': 18.667,
        '2/15/2007': 16.391,
        '2/16/2007': 10.696,
        '2/17/2007': 11.148,
        '2/18/2007': 27.239,
        '2/19/2007': 17.619,
        '2/20/2007': 16.962,
        '2/21/2007': 17.407,
        '2/22/2007': 17.789,
        '2/23/2007': 11.289,
        '2/24/2007': 3.925,
        '2/25/2007': 1.989,
        '2/26/2007': 3.161,
        '2/27/2007': 2.238,
        '2/28/2007': 2.313,
        '3/1/2007': 2.296,
        '3/2/2007': 2.309,
        '3/3/2007': 4.944,
        '3/4/2007': 19.595,
        '3/5/2007': 27.862,
        '3/6/2007': 6.44,
        '3/7/2007': 21.35,
        '3/8/2007': 12.22,
        '3/9/2007': 10.069,
        '3/10/2007': 20.531,
        '3/11/2007': 17.73,
        '3/12/2007': 16.597,
        '3/13/2007': 10.532,
        '3/14/2007': 12.572,
        '3/15/2007': 14.299,
        '3/16/2007': 11.08,
        '3/17/2007': 14.842,
        '3/18/2007': 19.789,
        '3/19/2007': 18.452,
        '3/20/2007': 17.837,
        '3/21/2007': 18.333,
        '3/22/2007': 11.551,
        '3/23/2007': 10.273,
        '3/24/2007': 25.886,
        '3/25/2007': 17.588,
        '3/26/2007': 10.528,
        '3/27/2007': 6.716,
        '3/28/2007': 23.537,
        '3/29/2007': 12.346,
        '3/30/2007': 9.779,
        '3/31/2007': 28.009,
        '4/1/2007': 29.539,
        '4/2/2007': 19.366,
        '4/3/2007': 12.309,
        '4/4/2007': 18.602,
        '4/5/2007': 15.886,
        '4/6/2007': 14.632,
        '4/7/2007': 10.161,
        '4/8/2007': 4.03,
        '4/9/2007': 6.982,
        '4/10/2007': 3.523,
        '4/11/2007': 7.533,
        '4/12/2007': 2.359,
        '4/13/2007': 2.546,
        '4/14/2007': 2.586,
        '4/15/2007': 3.919,
        '4/16/2007': 6.913,
        '4/17/2007': 8.12,
        '4/18/2007': 5.364,
        '4/19/2007': 8.086,
        '4/20/2007': 4.928,
        '4/21/2007': 18.167,
        '4/22/2007': 17.653,
        '4/23/2007': 7.913,
        '4/24/2007': 8.332,
        '4/25/2007': 10.281,
        '4/26/2007': 10.332,
        '4/27/2007': 7.073,
        '4/28/2007': 0.018,
        '4/30/2007': 2.845,
        '5/1/2007': 13.546,
        '5/2/2007': 5.251,
        '5/3/2007': 11.467,
        '5/4/2007': 6.787,
        '5/5/2007': 16.709,
        '5/6/2007': 14.259,
        '5/7/2007': 15.314,
        '5/8/2007': 15.369,
        '5/9/2007': 18.123,
        '5/10/2007': 4.741,
        '5/11/2007': 7.888,
        '5/12/2007': 13.73,
        '5/13/2007': 14.984,
        '5/14/2007': 11.11,
        '5/15/2007': 5.726,
        '5/16/2007': 17.046,
        '5/17/2007': 10.774,
        '5/18/2007': 15.299,
        '5/19/2007': 12.235,
        '5/20/2007': 14.764,
        '5/21/2007': 9.528,
        '5/22/2007': 8.881,
        '5/23/2007': 12.867,
        '5/24/2007': 9.817,
        '5/25/2007': 15.185,
        '5/26/2007': 13.755,
        '5/27/2007': 20.344,
        '5/28/2007': 14.613,
        '5/29/2007': 6.239,
        '5/30/2007': 16.002,
        '5/31/2007': 4.964,
        '6/1/2007': 8.147,
        '6/2/2007': 12.854,
        '6/3/2007': 20.848,
        '6/4/2007': 6.954,
        '6/5/2007': 11.959,
        '6/6/2007': 15.821,
        '6/7/2007': 5.643,
        '6/8/2007': 25.619,
        '6/9/2007': 8.038,
        '6/10/2007': 12.109,
        '6/11/2007': 5.815,
        '6/12/2007': 6.255,
        '6/13/2007': 7.03,
        '6/14/2007': 12.523,
        '6/15/2007': 10.827,
        '6/16/2007': 18.895,
        '6/17/2007': 17.896,
        '6/18/2007': 4.77,
        '6/19/2007': 5.865,
        '6/20/2007': 9.455,
        '6/21/2007': 7.043,
        '6/22/2007': 4.433,
        '6/23/2007': 3.188,
        '6/24/2007': 4.24,
        '6/25/2007': 10.422,
        '6/26/2007': 7.536,
        '6/27/2007': 16.324,
        '6/28/2007': 13.909,
        '6/29/2007': 11.827,
        '6/30/2007': 12.217,
        '7/1/2007': 6.395,
        '7/2/2007': 9.744,
        '7/3/2007': 8.376,
        '7/4/2007': 10.179,
        '7/5/2007': 7.665,
        '7/6/2007': 10.394,
        '7/7/2007': 14.221,
        '7/8/2007': 9.933,
        '7/9/2007': 10.903,
        '7/10/2007': 6.925,
        '7/11/2007': 6.946,
        '7/12/2007': 9.998,
        '7/13/2007': 5.06,
        '7/14/2007': 12.347,
        '7/15/2007': 7.079,
        '7/16/2007': 5.701,
        '7/17/2007': 4.877,
        '7/18/2007': 6.208,
        '7/19/2007': 4.901,
        '7/20/2007': 9.294,
        '7/21/2007': 8.696,
        '7/22/2007': 14.79,
        '7/23/2007': 6.882,
        '7/24/2007': 7.206,
        '7/25/2007': 2.484,
        '7/26/2007': 8.954,
        '7/27/2007': 9.043,
        '7/28/2007': 17.731,
        '7/29/2007': 1.288,
        '7/30/2007': 2.528,
        '7/31/2007': 6.852,
        '8/1/2007': 11.395,
        '8/2/2007': 7.351,
        '8/3/2007': 10.097,
        '8/4/2007': 8.916,
        '8/5/2007': 6.816,
        '8/6/2007': 9.081,
        '8/7/2007': 11.647,
        '8/8/2007': 11.826,
        '8/9/2007': 11.343,
        '8/10/2007': 11.274,
        '8/11/2007': 12.429,
        '8/12/2007': 10.861,
        '8/13/2007': 11.67,
        '8/14/2007': 7.892,
        '8/15/2007': 10.633,
        '8/16/2007': 8.438,
        '8/17/2007': 8.013,
        '8/18/2007': 1.83,
        '8/19/2007': 15.926,
        '8/20/2007': 15.38,
        '8/21/2007': 3.334,
        '8/22/2007': 12.125,
        '8/23/2007': 8.103,
        '8/24/2007': 15.617,
        '8/25/2007': 12.018,
        '8/26/2007': 10.844,
        '8/27/2007': 9.878,
        '8/28/2007': 8.989,
        '8/29/2007': 6.451,
        '8/30/2007': 10.623,
        '8/31/2007': 10.604,
        '9/1/2007': 12.799,
        '9/2/2007': 14.036,
        '9/3/2007': 8.459,
        '9/4/2007': 16.25,
        '9/5/2007': 10.849,
        '9/6/2007': 7.349,
        '9/7/2007': 13.571,
        '9/8/2007': 14.304,
        '9/9/2007': 15.855,
        '9/10/2007': 7.143,
        '9/11/2007': 7.285,
        '9/12/2007': 10.972,
        '9/13/2007': 7.551,
        '9/14/2007': 7.381,
        '9/15/2007': 7.913,
        '9/16/2007': 15.492,
        '9/17/2007': 13.856,
        '9/18/2007': 9.342,
        '9/19/2007': 10.68,
        '9/20/2007': 11.541,
        '9/21/2007': 12.191,
        '9/22/2007': 9.943,
        '9/23/2007': 12.142,
        '9/24/2007': 12.819,
        '9/25/2007': 12.989,
        '9/26/2007': 16.134,
        '9/27/2007': 9.033,
        '9/28/2007': 14.67,
        '9/29/2007': 19.732,
        '9/30/2007': 12.212,
        '10/1/2007': 14.089,
        '10/2/2007': 21.345,
        '10/3/2007': 9.695,
        '10/4/2007': 12.554,
        '10/5/2007': 9.776,
        '10/6/2007': 14.853,
        '10/7/2007': 21.639,
        '10/8/2007': 5.502,
        '10/9/2007': 13.471,
        '10/10/2007': 7.325,
        '10/11/2007': 10.85,
        '10/12/2007': 17.707,
        '10/13/2007': 13.231,
        '10/14/2007': 17.55,
        '10/15/2007': 9.054,
        '10/16/2007': 17.747,
        '10/17/2007': 10.486,
        '10/18/2007': 11.343,
        '10/19/2007': 16.071,
        '10/20/2007': 15.884,
        '10/21/2007': 15.382,
        '10/22/2007': 13.326,
        '10/23/2007': 16.933,
        '10/24/2007': 13.938,
        '10/25/2007': 11.296,
        '10/26/2007': 6.114,
        '10/27/2007': 15.179,
        '10/28/2007': 2.048,
        '10/29/2007': 3.018,
        '10/30/2007': 6.191,
        '10/31/2007': 13.615,
        '11/1/2007': 2.284,
        '11/2/2007': 15.706,
        '11/3/2007': 2.218,
        '11/4/2007': 11.455,
        '11/5/2007': 8.245,
        '11/6/2007': 17.31,
        '11/7/2007': 11.717,
        '11/8/2007': 8.529,
        '11/9/2007': 19.948,
        '11/10/2007': 17.768,
        '11/11/2007': 9.789,
        '11/12/2007': 18.464,
        '11/13/2007': 16.987,
        '11/14/2007': 17.695,
        '11/15/2007': 9.68,
        '11/16/2007': 20.215,
        '11/17/2007': 19.777,
        '11/18/2007': 14.364,
        '11/19/2007': 12.092,
        '11/20/2007': 15.995,
        '11/21/2007': 11.143,
        '11/22/2007': 12.165,
        '11/23/2007': 22.034,
        '11/24/2007': 19.155,
        '11/25/2007': 9.513,
        '11/26/2007': 10.302,
        '11/27/2007': 27.194,
        '11/28/2007': 9.761,
        '11/29/2007': 11.132,
        '11/30/2007': 21.542,
        '12/1/2007': 27.556,
        '12/2/2007': 19.641,
        '12/3/2007': 11.868,
        '12/4/2007': 15.401,
        '12/5/2007': 14.636,
        '12/6/2007': 16.977,
        '12/7/2007': 14.432,
        '12/8/2007': 15.77,
        '12/9/2007': 15.332,
        '12/10/2007': 9.661,
        '12/11/2007': 17.607,
        '12/12/2007': 9.165,
        '12/13/2007': 11.462,
        '12/14/2007': 17.77,
        '12/15/2007': 19.706,
        '12/16/2007': 18.62,
        '12/17/2007': 12.446,
        '12/18/2007': 18.026,
        '12/19/2007': 15.57,
        '12/20/2007': 15.727,
        '12/21/2007': 13.642,
        '12/22/2007': 21.042,
        '12/23/2007': 17.024,
        '12/24/2007': 19.651,
        '12/25/2007': 17.04,
        '12/26/2007': 13.362,
        '12/27/2007': 13.572,
        '12/28/2007': 26.357,
        '12/29/2007': 22.176,
        '12/30/2007': 20.677,
        '12/31/2007': 17.528,
      };
      const dataYear = 2007;

      const springStart = new Date(`3/21/${dataYear}`).getTime();
      const springEnd = new Date(`6/20/${dataYear}`).getTime();

      const summerStart = new Date(`6/21/${dataYear}`).getTime();
      const summerEnd = new Date(`9/20/${dataYear}`).getTime();

      const autumnStart = new Date(`9/21/${dataYear}`).getTime();
      const autumnEnd = new Date(`12/20/${dataYear}`).getTime();

      // const winterStart = new Date(`12/21/${dataYear}`).getTime();
      // const winterEnd = new Date(`3/20/${dataYear}`).getTime();

      // used to assign nodes color by group
      // var color = d3.scaleOrdinal(d3.schemeCategory10);
      const color = date => {
        date = date.getTime();
        if (springStart <= date && date <= springEnd) return `#228B22`;
        else if (summerStart <= date && date <= summerEnd) return `#DC143C`;
        else if (autumnStart <= date && date <= autumnEnd) return `#FF8C00`;
        else return `#1E90FF`; // Winter
      };
      // var color = d3.scaleOrdinal(defaultColors);
      // console.log(color);

      const dates = Object.keys(data2007);
      const energyValues = Object.values(data2007);

      var spiralLength = path.node().getTotalLength(),
        N = dates.length,
        barWidth = spiralLength / N - 1;
      var someData = [];
      for (var i = 0; i < N; i++) {
        var currentDate = new Date(dates[i]);
        currentDate.setDate(currentDate.getDate());
        someData.push({
          date: currentDate,
          value: energyValues[i],
          //value: Math.random(),
          group: currentDate.getMonth(),
        });
      }
      // console.log(someData[300].group);

      var timeScale = d3
        .scaleTime()
        .domain(
          d3.extent(someData, function(d) {
            return d.date;
          }),
        )
        .range([0, spiralLength]);

      // yScale for the bar height
      var yScale = d3
        .scaleLinear()
        .domain([
          0,
          d3.max(someData, function(d) {
            return d.value;
          }),
        ])
        .range([0, r / numSpirals - 30]);

      // svg.selectAll("text")
      // .data(someData)
      // .enter()
      // .append("text")
      // .attr("x", function(d,i){

      //   var linePer = timeScale(d.date),
      //       posOnLine = path.node().getPointAtLength(linePer),
      //       angleOnLine = path.node().getPointAtLength(linePer - barWidth);

      //   d.linePer = linePer; // % distance are on the spiral
      //   d.x = posOnLine.x;  // x postion on the spiral
      //   d.y = posOnLine.y; // y position on the spiral

      //   d.a = (Math.atan2(angleOnLine.y, angleOnLine.x) * 180 / Math.PI) - 90; //angle at the spiral position

      //   return d.x;
      // })
      // .attr("y", function(d){
      //   return d.y;
      // })
      // .attr("transform", function(d){
      //   return "rotate(" + d.a + "," + d.x  + "," + d.y + ")"; // rotate the bar
      // })
      // .text("1.1")
      // .style("font", "7px Arial")

      ////
      svg
        .selectAll('rect')
        .data(someData)
        .enter()
        .append('rect')
        .attr('x', function(d, i) {
          var linePer = timeScale(d.date),
            posOnLine = path.node().getPointAtLength(linePer),
            angleOnLine = path.node().getPointAtLength(linePer - barWidth);

          d.linePer = linePer; // % distance are on the spiral
          d.x = posOnLine.x; // x postion on the spiral
          d.y = posOnLine.y; // y position on the spiral

          d.a = (Math.atan2(angleOnLine.y, angleOnLine.x) * 180) / Math.PI - 90; //angle at the spiral position

          return d.x;
        })
        .attr('y', function(d) {
          return d.y;
        })
        .attr('width', function(d) {
          return barWidth;
        })
        .attr('height', function(d) {
          return yScale(d.value);
        })
        .style('fill', function(d) {
          // console.log(color(d.group));
          return color(d.date);
        })
        .style('stroke', 'none')
        .attr('transform', function(d) {
          return 'rotate(' + d.a + ',' + d.x + ',' + d.y + ')'; // rotate the bar
        });

      // add date labels
      var tF = d3.timeFormat('%b %Y'),
        firstInMonth = {};
      svg
        .selectAll('text')
        .data(someData)
        .enter()
        .append('text')
        .attr('dy', 14)
        .style('text-anchor', 'start')
        .style('font', '18px Arial')
        .append('textPath')
        // only add for the first of each month
        .filter(function(d) {
          var sd = tF(d.date);
          if (!firstInMonth[sd]) {
            firstInMonth[sd] = 1;
            return true;
          }
          return false;
        })
        .text(function(d) {
          return tF(d.date);
        })
        // place text along spiral
        .attr('xlink:href', '#spiral')
        .style('fill', 'black')
        .attr('startOffset', function(d) {
          return (d.linePer / spiralLength) * 100 + '%';
        });

      var tooltip = d3
        .select('#chart')
        .append('div')
        .attr('class', 'tooltip');

      tooltip.append('div').attr('class', 'date');
      tooltip.append('div').attr('class', 'value');

      svg
        .selectAll('rect')
        .on('mouseover', function(d) {
          tooltip
            .select('.date')
            .html('Date: <b>' + d.date.toDateString() + '</b>');
          tooltip
            .select('.value')
            .html('Value: <b>' + Math.round(d.value * 100) / 100 + ' kWh<b>');

          d3.select(this)
            .style('fill', '#FFFFFF')
            .style('stroke', '#000000')
            .style('stroke-width', '2px');

          tooltip.style('display', 'block');
          tooltip.style('opacity', 2);
        })
        .on('mousemove', function(d) {
          tooltip
            .style('top', d3.event.layerY + 10 + 'px')
            .style('left', d3.event.layerX - 25 + 'px');
        })
        .on('mouseout', function(d) {
          d3.selectAll('rect')
            .style('fill', function(d) {
              return color(d.date);
            })
            .style('stroke', 'none');

          tooltip.style('display', 'none');
          tooltip.style('opacity', 0);
        });
    </script>
  </body>
</html>
